name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      # Testes j√° s√£o executados no workflow SonarCloud
      # Removido para evitar duplica√ß√£o e acelerar deploy
      # Se quiser validar antes de deployar, descomente abaixo:
      # - name: Run tests
      #   working-directory: ./backend
      #   env:
      #     DATABASE_URL: ${{ secrets.DATABASE_URL }}
      #     JWT_SECRET: ${{ secrets.JWT_SECRET }}
      #     NODE_ENV: test
      #   run: npm test

      - name: Build application
        working-directory: ./backend
        run: npm run build

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: Create deployment package
        run: |
          cd backend
          tar -czf ../deploy.tar.gz \
            dist/ \
            package.json \
            package-lock.json \
            prisma/ \
            newrelic.js \
            .env.example || true
          cd ..

      - name: Create directories and copy file to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # Criar diret√≥rios (mkdir -p n√£o faz nada se j√° existir)
            mkdir -p /home/${{ secrets.EC2_USER }}/app
            mkdir -p /home/${{ secrets.EC2_USER }}/app/backend
            mkdir -p /home/${{ secrets.EC2_USER }}/app/logs
            echo "‚úÖ Diret√≥rios verificados/criados"
            
            # Verificar se diret√≥rio existe
            if [ -d "/home/${{ secrets.EC2_USER }}/app" ]; then
              echo "‚úÖ Diret√≥rio /home/${{ secrets.EC2_USER }}/app existe"
            else
              echo "‚ùå Diret√≥rio n√£o existe"
              exit 1
            fi

      - name: Copy files to EC2
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_USER: ${{ secrets.EC2_USER }}
          REMOTE_PORT: ${{ secrets.EC2_PORT || 22 }}
          ARGS: "-rltgoDzvO"
          SOURCE: "deploy.tar.gz"
          TARGET: "/home/${{ secrets.EC2_USER }}/app/"

      - name: Execute deployment script on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # Criar diret√≥rios necess√°rios
            echo "üìÅ Criando diret√≥rios..."
            mkdir -p /home/${{ secrets.EC2_USER }}/app
            mkdir -p /home/${{ secrets.EC2_USER }}/app/backend
            mkdir -p /home/${{ secrets.EC2_USER }}/app/logs
            cd /home/${{ secrets.EC2_USER }}/app
            
            # Verificar se arquivo foi copiado
            if [ -f deploy.tar.gz ]; then
              echo "‚úÖ Arquivo deploy.tar.gz encontrado"
              echo "üì¶ Extraindo arquivo de deploy..."
              cd backend
              tar -xzf ../deploy.tar.gz || exit 1
              rm -f ../deploy.tar.gz
              echo "‚úÖ Arquivo extra√≠do com sucesso"
            else
              echo "‚ùå Arquivo deploy.tar.gz n√£o encontrado em /home/${{ secrets.EC2_USER }}/app"
              echo "üìÇ Listando arquivos no diret√≥rio:"
              ls -la /home/${{ secrets.EC2_USER }}/app || true
              echo "üìÇ Listando arquivos no diret√≥rio home:"
              ls -la /home/${{ secrets.EC2_USER }}/ || true
              exit 1
            fi
            
            # Verificar se Node.js est√° instalado
            if ! command -v node &> /dev/null; then
              echo "üì• Instalando Node.js 20..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Instalar PM2 se n√£o estiver instalado
            if ! command -v pm2 &> /dev/null; then
              echo "üì• Instalando PM2..."
              sudo npm install -g pm2
            fi
            
            # Instalar depend√™ncias de produ√ß√£o
            echo "üì¶ Instalando depend√™ncias..."
            npm ci --production || exit 1
            
            # Gerar Prisma Client
            echo "üîß Gerando Prisma Client..."
            npx prisma generate || exit 1
            
            # Executar migra√ß√µes (se necess√°rio)
            if [ -d "prisma/migrations" ]; then
              echo "üîÑ Executando migra√ß√µes..."
              npx prisma migrate deploy || echo "‚ö†Ô∏è Migra√ß√µes j√° aplicadas ou sem mudan√ßas"
            fi
            
            # Verificar/criar arquivo .env
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è Arquivo .env n√£o encontrado"
              if [ -f ".env.example" ]; then
                cp .env.example .env
                echo "üìù Copiado .env.example para .env - CONFIGURE AS VARI√ÅVEIS!"
              fi
            fi
            
            # Criar diret√≥rio de uploads
            mkdir -p uploads/evidences
            chmod 755 uploads/evidences
            
            # Parar aplica√ß√£o anterior
            echo "üõë Parando aplica√ß√£o anterior..."
            pm2 stop qa-test-manager-backend || echo "Aplica√ß√£o n√£o estava rodando"
            pm2 delete qa-test-manager-backend || echo "Aplica√ß√£o n√£o existia"
            
            # Iniciar aplica√ß√£o com PM2
            echo "üöÄ Iniciando aplica√ß√£o..."
            pm2 start dist/main.js \
              --name qa-test-manager-backend \
              --instances 1 \
              --max-memory-restart 500M \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
              --error-log "/home/${{ secrets.EC2_USER }}/app/logs/error.log" \
              --out-log "/home/${{ secrets.EC2_USER }}/app/logs/out.log" \
              --merge-logs \
              --time || exit 1
            
            # Salvar configura√ß√£o do PM2
            pm2 save || echo "‚ö†Ô∏è Falha ao salvar configura√ß√£o PM2"
            
            # Verificar status
            sleep 3
            if pm2 list | grep -q "qa-test-manager-backend.*online"; then
              echo "‚úÖ Deploy conclu√≠do com sucesso!"
              pm2 list
            else
              echo "‚ùå Falha ao iniciar aplica√ß√£o"
              pm2 logs qa-test-manager-backend --lines 20
              exit 1
            fi

      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz