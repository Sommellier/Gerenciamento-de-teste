name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  test-and-analyze:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 4422
          POSTGRES_DB: qa_test_manager
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:4422@localhost:5432/qa_test_manager
      JWT_SECRET: qualquercoisa
      FRONTEND_URL: http://localhost:8080
      EMAIL_FROM: fake@example.com
      EMAIL_PASSWORD: fakepassword

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend deps
        working-directory: backend
        run: npm ci

      - name: Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: Setup Database Schema
        working-directory: backend
        run: npx prisma db push --accept-data-loss --skip-generate

      - name: Run backend tests with coverage
        working-directory: backend
        run: npm run test:coverage -- --runInBand --silent

      - name: Install frontend deps
        working-directory: frontend/quasar-project
        run: npm ci

      - name: Run frontend unit tests with coverage
        working-directory: frontend/quasar-project
        run: npm run test:unit || echo "Frontend tests skipped if not configured"

  deploy:
    needs: test-and-analyze
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install PM2
        run: npm i -g pm2

      - name: Configure SSH to EC2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "Host target\n  HostName %s\n  User %s\n  IdentityFile ~/.ssh/id_ed25519\n  IdentitiesOnly yes\n  StrictHostKeyChecking accept-new\n  ServerAliveInterval 60\n  ServerAliveCountMax 30\n  TCPKeepAlive yes\n" \
            "${{ secrets.EC2_HOST }}" "${{ secrets.EC2_USER }}" > ~/.ssh/config

      - name: Debug SSH reachability
        run: |
          set -x
          ssh -o ConnectTimeout=10 target "echo SSH_OK" || exit 1

      - name: PM2 deploy setup
        run: pm2 deploy ecosystem.config.js production setup || true

      - name: PM2 deploy release
        timeout-minutes: 15
        run: |
          # Configurar SSH para manter conex√£o viva
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=30 -o TCPKeepAlive=yes target "echo 'SSH connection test'" || true
          # Executar deploy com timeout aumentado
          pm2 deploy ecosystem.config.js production --force

  deploy-legacy:
    name: Deploy to EC2 (Legacy)
    if: false # Desabilitado - usar apenas o job 'deploy' com PM2
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build application
        working-directory: ./backend
        run: npm run build

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: Create deployment package
        run: |
          cd backend
          tar -czf ../deploy.tar.gz \
            dist/ \
            package.json \
            package-lock.json \
            prisma/ \
            newrelic.js \
            .env.example || true
          cd ..

      - name: Prepare directories on EC2
        uses: appleboy/ssh-action@master
        timeout-minutes: 2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          command_timeout: 30s
          script_stop: true
          script: |
            set -e
            echo "üîç Iniciando prepara√ß√£o de diret√≥rios..."
            
            # Verificar se existe arquivo com nome 'app' e remover se necess√°rio
            if [ -f "/home/${{ secrets.EC2_USER }}/app" ]; then
              echo "‚ö†Ô∏è Arquivo 'app' encontrado, removendo..."
              rm -f /home/${{ secrets.EC2_USER }}/app
            fi
            
            # Criar diret√≥rios se n√£o existirem (mkdir -p √© idempotente)
            echo "üìÅ Criando diret√≥rios..."
            mkdir -p /home/${{ secrets.EC2_USER }}/app/backend
            mkdir -p /home/${{ secrets.EC2_USER }}/app/logs
            
            # Verificar se diret√≥rio existe
            if [ -d "/home/${{ secrets.EC2_USER }}/app" ]; then
              echo "‚úÖ Diret√≥rio /home/${{ secrets.EC2_USER }}/app pronto"
              ls -la /home/${{ secrets.EC2_USER }}/app
            else
              echo "‚ùå Falha ao criar diret√≥rio"
              exit 1
            fi
            echo "‚úÖ Prepara√ß√£o conclu√≠da"

      - name: Copy files to EC2
        timeout-minutes: 5
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_USER: ${{ secrets.EC2_USER }}
          REMOTE_PORT: ${{ secrets.EC2_PORT || 22 }}
          ARGS: "-rltgoDzvO"
          SOURCE: "deploy.tar.gz"
          TARGET: "/home/${{ secrets.EC2_USER }}/app/"

      - name: Execute deployment script on EC2
        timeout-minutes: 10
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          command_timeout: 300s
          script_stop: true
          script: |
            set -e
            echo "üöÄ Iniciando deploy..."
            # Navegar para diret√≥rio de deploy
            cd /home/${{ secrets.EC2_USER }}/app
            
            # Verificar se arquivo foi copiado
            if [ -f deploy.tar.gz ]; then
              echo "‚úÖ Arquivo deploy.tar.gz encontrado"
              echo "üì¶ Extraindo arquivo de deploy..."
              cd backend
              
              # Preservar arquivos importantes antes da extra√ß√£o
              if [ -f ".env" ]; then
                echo "üíæ Fazendo backup do .env..."
                cp .env .env.backup
              fi
              
              if [ -d "uploads" ]; then
                echo "üíæ Fazendo backup do diret√≥rio uploads..."
                cp -r uploads uploads.backup || true
              fi
              
              # Extrair arquivos (pode sobrescrever alguns arquivos, mas n√£o deleta diret√≥rios)
              tar -xzf ../deploy.tar.gz || exit 1
              
              # Restaurar arquivos preservados
              if [ -f ".env.backup" ]; then
                echo "‚úÖ Restaurando .env preservado..."
                mv .env.backup .env
              fi
              
              if [ -d "uploads.backup" ]; then
                echo "‚úÖ Restaurando diret√≥rio uploads preservado..."
                # Mesclar conte√∫do: manter arquivos existentes e adicionar novos se necess√°rio
                if [ ! -d "uploads" ]; then
                  mkdir -p uploads
                fi
                # Copiar apenas arquivos que n√£o existem no destino
                find uploads.backup -type f -exec sh -c 'if [ ! -f "uploads/$(basename "$1")" ]; then cp "$1" "uploads/"; fi' _ {} \; || true
                rm -rf uploads.backup
              fi
              
              rm -f ../deploy.tar.gz
              echo "‚úÖ Arquivo extra√≠do com sucesso"
            else
              echo "‚ùå Arquivo deploy.tar.gz n√£o encontrado em /home/${{ secrets.EC2_USER }}/app"
              echo "üìÇ Listando arquivos no diret√≥rio:"
              ls -la /home/${{ secrets.EC2_USER }}/app || true
              echo "üìÇ Listando arquivos no diret√≥rio home:"
              ls -la /home/${{ secrets.EC2_USER }}/ || true
              exit 1
            fi
            
            # Verificar se Node.js est√° instalado
            if ! command -v node &> /dev/null; then
              echo "üì• Instalando Node.js 20..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Instalar PM2 se n√£o estiver instalado
            if ! command -v pm2 &> /dev/null; then
              echo "üì• Instalando PM2..."
              sudo npm install -g pm2
            fi
            
            # Verificar/criar arquivo .env ANTES de instalar depend√™ncias
            # (O .env foi preservado durante a extra√ß√£o, ent√£o s√≥ cria se realmente n√£o existir)
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è Arquivo .env n√£o encontrado"
              if [ -f ".env.example" ]; then
                cp .env.example .env
                echo "üìù Copiado .env.example para .env"
              else
                echo "üìù Criando arquivo .env b√°sico..."
                printf 'NODE_ENV=production\nPORT=3000\nDATABASE_URL=postgresql://usuario:senha@host:5432/qa_test_manager\nJWT_SECRET=CHANGE_THIS_SECRET_KEY\nFRONTEND_URL=https://seu-frontend.com\n' > .env
                echo "‚ö†Ô∏è IMPORTANTE: Configure as vari√°veis de ambiente no arquivo .env!"
              fi
            else
              echo "‚úÖ Arquivo .env preservado (n√£o ser√° sobrescrito)"
            fi
            
            # Verificar se DATABASE_URL est√° configurado
            if ! grep -q "DATABASE_URL=" .env || grep -q "DATABASE_URL=postgresql://usuario:senha" .env; then
              echo "‚ö†Ô∏è ATEN√á√ÉO: DATABASE_URL n√£o est√° configurado corretamente no .env"
              echo "‚ö†Ô∏è Configure a vari√°vel DATABASE_URL antes de continuar"
            fi
            
            # Instalar depend√™ncias de produ√ß√£o
            echo "üì¶ Instalando depend√™ncias..."
            npm ci --production || exit 1
            
            # Gerar Prisma Client
            echo "üîß Gerando Prisma Client..."
            npx prisma generate || exit 1
            
            # Executar migra√ß√µes (se necess√°rio)
            if [ -d "prisma/migrations" ]; then
              echo "üîÑ Executando migra√ß√µes..."
              npx prisma migrate deploy || echo "‚ö†Ô∏è Migra√ß√µes j√° aplicadas ou sem mudan√ßas"
            fi
            
            # Criar diret√≥rio de uploads
            mkdir -p uploads/evidences
            chmod 755 uploads/evidences
            
            # Parar aplica√ß√£o anterior
            echo "üõë Parando aplica√ß√£o anterior..."
            pm2 stop qa-test-manager-backend || echo "Aplica√ß√£o n√£o estava rodando"
            pm2 delete qa-test-manager-backend || echo "Aplica√ß√£o n√£o existia"
            
            # Iniciar aplica√ß√£o com PM2
            echo "üöÄ Iniciando aplica√ß√£o..."
            pm2 start dist/main.js \
              --name qa-test-manager-backend \
              --instances 1 \
              --max-memory-restart 500M \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
              --log "/home/${{ secrets.EC2_USER }}/app/logs/app.log" \
              --error "/home/${{ secrets.EC2_USER }}/app/logs/error.log" \
              --output "/home/${{ secrets.EC2_USER }}/app/logs/out.log" \
              --merge-logs \
              --time || exit 1
            
            # Salvar configura√ß√£o do PM2
            pm2 save || echo "‚ö†Ô∏è Falha ao salvar configura√ß√£o PM2"
            
            # Verificar status
            sleep 3
            if pm2 list | grep -q "qa-test-manager-backend.*online"; then
              echo "‚úÖ Deploy conclu√≠do com sucesso!"
              pm2 list
            else
              echo "‚ùå Falha ao iniciar aplica√ß√£o"
              pm2 logs qa-test-manager-backend --lines 20
              exit 1
            fi

      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz
