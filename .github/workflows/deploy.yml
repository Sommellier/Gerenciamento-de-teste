name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
      - master
      - teste
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      # Testes jÃ¡ sÃ£o executados no workflow SonarCloud
      # Removido para evitar duplicaÃ§Ã£o e acelerar deploy
      # Se quiser validar antes de deployar, descomente abaixo:
      # - name: Run tests
      #   working-directory: ./backend
      #   env:
      #     DATABASE_URL: ${{ secrets.DATABASE_URL }}
      #     JWT_SECRET: ${{ secrets.JWT_SECRET }}
      #     NODE_ENV: test
      #   run: npm test

      - name: Build application
        working-directory: ./backend
        run: npm run build

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: Create deployment package
        run: |
          cd backend
          tar -czf ../deploy.tar.gz \
            dist/ \
            package.json \
            package-lock.json \
            prisma/ \
            newrelic.js \
            .env.example || true
          cd ..

      - name: Prepare directories on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # Verificar se existe arquivo com nome 'app' e remover se necessÃ¡rio
            if [ -f "/home/${{ secrets.EC2_USER }}/app" ]; then
              echo "âš ï¸ Arquivo 'app' encontrado, removendo..."
              rm -f /home/${{ secrets.EC2_USER }}/app
            fi
            
            # Criar diretÃ³rios se nÃ£o existirem (mkdir -p Ã© idempotente)
            mkdir -p /home/${{ secrets.EC2_USER }}/app/backend
            mkdir -p /home/${{ secrets.EC2_USER }}/app/logs
            
            # Verificar se diretÃ³rio existe
            if [ -d "/home/${{ secrets.EC2_USER }}/app" ]; then
              echo "âœ… DiretÃ³rio /home/${{ secrets.EC2_USER }}/app pronto"
            else
              echo "âŒ Falha ao criar diretÃ³rio"
              exit 1
            fi

      - name: Copy files to EC2
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_USER: ${{ secrets.EC2_USER }}
          REMOTE_PORT: ${{ secrets.EC2_PORT || 22 }}
          ARGS: "-rltgoDzvO"
          SOURCE: "deploy.tar.gz"
          TARGET: "/home/${{ secrets.EC2_USER }}/app/"

      - name: Execute deployment script on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # Navegar para diretÃ³rio de deploy
            cd /home/${{ secrets.EC2_USER }}/app
            
            # Verificar se arquivo foi copiado
            if [ -f deploy.tar.gz ]; then
              echo "âœ… Arquivo deploy.tar.gz encontrado"
              echo "ðŸ“¦ Extraindo arquivo de deploy..."
              cd backend
              tar -xzf ../deploy.tar.gz || exit 1
              rm -f ../deploy.tar.gz
              echo "âœ… Arquivo extraÃ­do com sucesso"
            else
              echo "âŒ Arquivo deploy.tar.gz nÃ£o encontrado em /home/${{ secrets.EC2_USER }}/app"
              echo "ðŸ“‚ Listando arquivos no diretÃ³rio:"
              ls -la /home/${{ secrets.EC2_USER }}/app || true
              echo "ðŸ“‚ Listando arquivos no diretÃ³rio home:"
              ls -la /home/${{ secrets.EC2_USER }}/ || true
              exit 1
            fi
            
            # Verificar se Node.js estÃ¡ instalado
            if ! command -v node &> /dev/null; then
              echo "ðŸ“¥ Instalando Node.js 20..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Instalar PM2 se nÃ£o estiver instalado
            if ! command -v pm2 &> /dev/null; then
              echo "ðŸ“¥ Instalando PM2..."
              sudo npm install -g pm2
            fi
            
            # Verificar/criar arquivo .env ANTES de instalar dependÃªncias
            if [ ! -f ".env" ]; then
              echo "âš ï¸ Arquivo .env nÃ£o encontrado"
              if [ -f ".env.example" ]; then
                cp .env.example .env
                echo "ðŸ“ Copiado .env.example para .env"
              else
                echo "ðŸ“ Criando arquivo .env bÃ¡sico..."
                cat > .env << 'EOF'
NODE_ENV=production
PORT=3000
DATABASE_URL=postgresql://usuario:senha@host:5432/qa_test_manager
JWT_SECRET=CHANGE_THIS_SECRET_KEY
FRONTEND_URL=https://seu-frontend.com
EOF
                echo "âš ï¸ IMPORTANTE: Configure as variÃ¡veis de ambiente no arquivo .env!"
              fi
            else
              echo "âœ… Arquivo .env jÃ¡ existe"
            fi
            
            # Verificar se DATABASE_URL estÃ¡ configurado
            if ! grep -q "DATABASE_URL=" .env || grep -q "DATABASE_URL=postgresql://usuario:senha" .env; then
              echo "âš ï¸ ATENÃ‡ÃƒO: DATABASE_URL nÃ£o estÃ¡ configurado corretamente no .env"
              echo "âš ï¸ Configure a variÃ¡vel DATABASE_URL antes de continuar"
            fi
            
            # Instalar dependÃªncias de produÃ§Ã£o
            echo "ðŸ“¦ Instalando dependÃªncias..."
            npm ci --production || exit 1
            
            # Gerar Prisma Client
            echo "ðŸ”§ Gerando Prisma Client..."
            npx prisma generate || exit 1
            
            # Executar migraÃ§Ãµes (se necessÃ¡rio)
            if [ -d "prisma/migrations" ]; then
              echo "ðŸ”„ Executando migraÃ§Ãµes..."
              npx prisma migrate deploy || echo "âš ï¸ MigraÃ§Ãµes jÃ¡ aplicadas ou sem mudanÃ§as"
            fi
            
            # Criar diretÃ³rio de uploads
            mkdir -p uploads/evidences
            chmod 755 uploads/evidences
            
            # Parar aplicaÃ§Ã£o anterior
            echo "ðŸ›‘ Parando aplicaÃ§Ã£o anterior..."
            pm2 stop qa-test-manager-backend || echo "AplicaÃ§Ã£o nÃ£o estava rodando"
            pm2 delete qa-test-manager-backend || echo "AplicaÃ§Ã£o nÃ£o existia"
            
            # Iniciar aplicaÃ§Ã£o com PM2
            echo "ðŸš€ Iniciando aplicaÃ§Ã£o..."
            pm2 start dist/main.js \
              --name qa-test-manager-backend \
              --instances 1 \
              --max-memory-restart 500M \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
              --log "/home/${{ secrets.EC2_USER }}/app/logs/app.log" \
              --error "/home/${{ secrets.EC2_USER }}/app/logs/error.log" \
              --output "/home/${{ secrets.EC2_USER }}/app/logs/out.log" \
              --merge-logs \
              --time || exit 1
            
            # Salvar configuraÃ§Ã£o do PM2
            pm2 save || echo "âš ï¸ Falha ao salvar configuraÃ§Ã£o PM2"
            
            # Verificar status
            sleep 3
            if pm2 list | grep -q "qa-test-manager-backend.*online"; then
              echo "âœ… Deploy concluÃ­do com sucesso!"
              pm2 list
            else
              echo "âŒ Falha ao iniciar aplicaÃ§Ã£o"
              pm2 logs qa-test-manager-backend --lines 20
              exit 1
            fi

      - name: Cleanup
        if: always()
        run: rm -f deploy.tar.gz