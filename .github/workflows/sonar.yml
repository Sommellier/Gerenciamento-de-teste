name: SonarCloud

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 4422
          POSTGRES_DB: qa_test_manager
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:4422@localhost:5432/qa_test_manager
      JWT_SECRET: qualquercoisa
      FRONTEND_URL: http://localhost:8080
      EMAIL_FROM: fake@example.com
      EMAIL_PASSWORD: fakepassword

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm install
        working-directory: ./backend

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: ./backend

      - name: Setup Database Schema
        run: |
          # Usar db push para aplicar schema completo, ignorando migrações
          npx prisma db push --accept-data-loss --skip-generate
        working-directory: ./backend
        env:
          DATABASE_URL: postgres://postgres:4422@localhost:5432/qa_test_manager

      - name: Run Tests with Coverage
        run: npm run test:coverage -- --runInBand
        working-directory: ./backend

      - name: Verify Coverage File Exists
        working-directory: ./backend
        run: |
          if [ ! -f "coverage/lcov.info" ]; then
            echo "Error: coverage/lcov.info file not found!"
            exit 1
          fi
          echo "Coverage file found at coverage/lcov.info"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ./backend
          args: >
            -Dsonar.projectKey=Sommellier_Gerenciamento-de-teste
            -Dsonar.organization=sommellier
            -Dsonar.sources=src
            -Dsonar.exclusions=**/*.d.ts,**/dist/**,**/migrations/**,**/prisma/**,src/tests/**
            -Dsonar.tests=src/tests
            -Dsonar.test.inclusions=src/**/*.test.ts,src/**/*.spec.ts
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=src/main.ts,src/server.ts,src/tests/**
            -Dsonar.newCode.referenceBranch=main
            -Dsonar.language=ts
            -Dsonar.sourceEncoding=UTF-8
             # =========================
      # FRONTEND (QUASAR)
      # =========================
      - name: Install Dependencies (frontend)
        run: npm install
        working-directory: ./frontend/quasar-project

      # Gerar .quasar/tsconfig.json necessário para o tsconfig.json principal
      - name: Generate Quasar TypeScript Config
        run: |
          mkdir -p .quasar
          cat > .quasar/tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              "target": "ES2022",
              "lib": ["ES2022", "DOM", "DOM.Iterable"],
              "module": "ESNext",
              "moduleResolution": "bundler",
              "jsx": "preserve",
              "strict": true,
              "esModuleInterop": true,
              "skipLibCheck": true,
              "resolveJsonModule": true,
              "allowSyntheticDefaultImports": true,
              "forceConsistentCasingInFileNames": true,
              "isolatedModules": true,
              "noEmit": true
            }
          }
          EOF
        working-directory: ./frontend/quasar-project

      # Gera cobertura com Vitest (@vitest/coverage-v8)
      - name: Run Tests with Coverage (frontend)
        run: npm run test:cov
        working-directory: ./frontend/quasar-project

      - name: Verify Coverage File Exists (frontend)
        working-directory: ./frontend/quasar-project
        run: |
          test -f coverage/lcov.info

      - name: SonarCloud Scan (frontend)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_FRONTEND }}
        with:
          projectBaseDir: ./frontend/quasar-project
          args: >
            -Dsonar.projectKey=Sommellier_Gerenciamento-de-teste-frontend
            -Dsonar.organization=sommellier
            -Dsonar.sources=src
            -Dsonar.exclusions=**/*.d.ts,**/node_modules/**,**/dist/**,**/.quasar/**,public/**,tests/**
            -Dsonar.tests=tests/unit
            -Dsonar.test.inclusions=tests/unit/**/*.{spec,test}.{ts,js}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=src/main.ts,src/router/**,src/boot/**,tests/**
            -Dsonar.newCode.referenceBranch=main
            -Dsonar.language=ts
            -Dsonar.sourceEncoding=UTF-8